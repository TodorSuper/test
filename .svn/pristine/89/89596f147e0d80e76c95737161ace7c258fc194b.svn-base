<?php

/**
 * +---------------------------------------------------------------------
 * | www.yunputong.com 粮人网
 * +---------------------------------------------------------------------
 * | Copyright (c) 2015 http://www.yunputong.com  All rights reserved.
 * +---------------------------------------------------------------------
 * | Author: zhoulianlei <zhoulianlei@yunputong.com >
 * +---------------------------------------------------------------------
 * | 用户扩展信息模块
 */

namespace Base\UserModule\User; 

use System\Base;

class User extends Base {

    private $_rule = null; # 验证规则列表
    private static $uc_prefix = null;

    public function __construct() {
        parent::__construct();
        self::$uc_prefix = 'Uc';
    }

    /**
     * 添加用户扩展信息
     * Base.UserModule.User.User.add
     * @param array $data   用户数据
     * @param integer $userType  预留用户类型   UC_USER_MERCHANT     UC_USER_MERCHANT 
     * @return integer   成功时返回  自增id
     */
    public function add($params) {
        $this->startOutsideTrans();
        $this->_rule = array(
            array('data', 'checkArrayInput', PARAMS_ERROR, MUST_CHECK, 'function'),
            array('userType', 'require', PARAMS_ERROR, MUST_CHECK),
        );
        if (!$this->checkInput($this->_rule, $params)) { # 自动校验
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $data = $params['data'];
        $userType = $params['userType'];

        //业务表示号  和  预留业务表示  的判定
        $userTable = self::getUserTable($userType);  //获取uc用户表名
        if (false === $userTable) {
            return $this->res(null, 4002);
        }
        //添加用户
        $res = D($userTable)->add($data);
        if ($res <= 0 || false === $res) {
            return $this->res(null, 4001);
        }
        return $this->res($res);
    }

    /**
     * 修改用户扩展信息
     * Base.UserModule.User.User.update
     * @param array $data   用户信息
     * @param intger $userType  预留用户类型   UC_USER_MERCHANT     UC_USER_MERCHANT 
     * @param intger $ucCode   用户编码
     * @return intger
     */
    public function update($params) {
        $this->startOutsideTrans();
        $this->_rule = array(
            array('data', 'checkArrayInput', PARAMS_ERROR, MUST_CHECK, 'function'),
            array('userType', 'require', PARAMS_ERROR, MUST_CHECK),
            array('uc_code', 'require', PARAMS_ERROR, MUST_CHECK),
        );
        //用户名，用户编码，自增id  不能更新  
        if (isset($params['data']['uc_code'])) {
            unset($params['data']['uc_code']);
        }
        if (isset($params['data']['username'])) {
            unset($params['data']['username']);
        }
        if (isset($params['data']['id'])) {
            unset($params['data']['id']);
        }

        if (!$this->checkInput($this->_rule, $params)) { # 自动校验
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $ucCode = $params['uc_code'];
        $data = $params['data'];
        $userType = $params['userType'];

		$userTable = self::getUserTable($userType);  //获取uc用户表名
		if($params['userType'] == UC_USER_MERMBER) {
			$where = array(
				'uc_code' =>$ucCode
			);
		}else {
			$where = array(
				'id' =>$ucCode
			);
			
		}
        $res = D($userTable)->where($where)->save($data);
        if (false === $res) {
            return $this->res(null, 4003);
        }
        return $this->res($res);  //返回影响函数    0  行 或  1行
    }

    /**
     * 删除或禁用 用户扩展信息
     * Base.UserModule.User.User.delete
     * @param array $status   修改状态信息
     * @param intger $userType  预留用户类型   UC_USER_MERCHANT     UC_USER_MERCHANT 
     * @param intger $ucCode   用户编码
     * @return intger
     */
    public function delete($params) {
        $this->startOutsideTrans();
        $this->_rule = array(
            array('uc_code', 'require', PARAMS_ERROR, MUST_CHECK),
        );
        if (!$this->checkInput($this->_rule, $params)) { # 自动校验
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $uc_code = $params['uc_code'];
        $userTable = self::getUserTable($userType);  //获取uc用户表名
        $res = D($userTable)->where(array('uc_code' => $uc_code))->save(array('status' => 'DISABLE', 'update_time' => NOW_TIME));
        if (false === $res || $res <= 0) {
            return $this->res(null, 4015);
        }
        return $this->res($res);
    }

    /**
     * 获取用户的所有信息
     * Base.UserModule.User.User.getFullUserInfo
     * @param intger $userType  预留用户类型   UC_USER_MERCHANT     UC_USER_MERCHANT 
     * @return intger
     */
    public function getFullUserInfo($params) {
        $this->_rule = array(
            array('open_id', 'require', PARAMS_ERROR, ISSET_CHECK), //微信的open_id  获取微信信息的时候有可能需要该参数
            array('uc_code', 'require', PARAMS_ERROR, ISSET_CHECK),
            array('user_type', 'require', PARAMS_ERROR, MUST_CHECK), //用户类型  UC_USER_MERCHANT     UC_USER_MERCHANT 
        );
        if (!$this->checkInput($this->_rule, $params)) { # 自动校验
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        
        $uc_code = $params['uc_code'];
        $open_id = $params['open_id'];
        $user_type = $params['user_type'];

        if (empty($open_id) && empty($uc_code)) {
            return $this->res(null, 4016);
        }
        
        $full_user_info = array();
        
        //如果是微信用户 

        if ($user_type == UC_USER_MERMBER) {
            $weixin_info = $this->getWeixinUserInfo($open_id, $uc_code);
            $uc_code = $weixin_info['uc_code'];
        }

        //获取用户基础信息
        $apiPath = "Base.UserModule.User.Basic.getBasicUserInfo";
        $data = array('uc_code'=>$uc_code);
        $basic_res = $this->invoke($apiPath, $data);
        if($basic_res['status'] != 0){
            return $this->res($basic_res['response'],$basic_res['status']);
        }
        $basic_user_info = $basic_res['response'];
        
        //基本信息
        $full_user_info['username'] = $basic_user_info['username'];
        $full_user_info['uc_code'] = $basic_user_info['uc_code'];
        $full_user_info['real_name'] = $basic_user_info['real_name'];
        $full_user_info['mobile'] = $basic_user_info['mobile'];
        $full_user_info['email'] = $basic_user_info['email'];
        $full_user_info['create_time'] = $basic_user_info['create_time'];
        $full_user_info['cms_group_id'] = $basic_user_info['group_id'];   //cms平台的group_id   区分微信用户的group_id
        $full_user_info['basic_status'] = $basic_user_info['status'];     //基础用户状态  是否删除
        
        //获取扩展信息
        $extend_user_table = self::getUserTable($user_type);
        //获取用户扩展信息
        $extend_user_info = D($extend_user_table)->where(array('uc_code'=>$uc_code))->find();
        
        //处理扩展信息
        $function = "get{$extend_user_table}ExtendInfo";
        $extend_info = $this->$function($extend_user_info);
        if(!empty($extend_info)){
           $full_user_info = array_merge($full_user_info,$extend_info);
        }
        
        //其他信息  如店铺  或者  微信信息
        
        return $this->res($full_user_info);
        
        
    }

    /**
     * 获取相应用户类型的表名
     * @param type $userType  用户类型
     * @return boolean
     */
    private static function getUserTable($userType) {
        $userTable = '';
        switch ($userType) {
            case UC_USER_MERCHANT:    //商户
                $userTable = 'Merchant';
                break;
            case UC_USER_MERMBER:     //用户
                $userTable = 'Member';
                break;
            default :
                return false;  //返回 4002 错误码
        }

        return self::$uc_prefix . $userTable;
    }

    /**
     * 获取微信用户信息
     * @param type $open_id
     * @param type $uc_code
     * @return type
     */
    private function getWeixinUserInfo($open_id, $uc_code = '') {
        $apiPath = "Base.WeiXinModule.User.User.getWeixinInfo";
        if (empty($uc_code)) {
            $data = array('open_id' => $open_id);
        } else {
            $data = array('uc_code' => $uc_code);
        }
        $weixin_user_res = $this->invoke($apiPath, $data);
        if ($weixin_user_res['status'] != 0 || empty($weixin_user_res['response'])) {
            return $this->endInvoke($weixin_user_res['response'], $weixin_user_res['status']);
        } 
        
        $weixin_user_info = $weixin_user_res['response'];
        return $weixin_user_info;
    }

	/**
	 * api登录接口,验证登录账号和密码的正确性
	 * login 
	 * Base.UserModule.User.User.login
	 * @param mixed $data
	 * @access public
	 * @return void
	 */

	public function login($data) {
		$this->_rule = array(
			array('username', 'require' , PARAMS_ERROR, MUST_CHECK ),  # 用户名				* 必须字段
			array('password', 'require' , PARAMS_ERROR, ISSET_CHECK ),  # 密码			
			array('sysName', 'require' , PARAMS_ERROR, ISSET_CHECK ),  # 要登陆到的系统		非必需 (不传入的话默认取调用系统名称的值)
		);
		
		if(!$this->checkInput($this->_rule, $data)) # 自动校验
			return $this->res($this->getErrorField(),$this->getCheckError());
		
		# 获取调用系统名称
		$sysName = $data['sysName'] ?$data['sysName'] : $this->_request_sys_name;


		# 获取基本用户信息
		$find = D('UcUser')->field('id,username,password,group_id,status,uc_code,real_name,mobile,email')->where(array('username'=>$data['username']))->find();
		if($find == null)  {
            if($sysName == BOSS){
                $login_key  = \Library\Key\RedisKeyMap::getLogin($data['username']);
                $redis = R();
                $num = $redis->get($login_key);
                $num = empty($num) ? 1 : (int)$num+1;
                $redis->set($login_key,$num);
                $redis->expire($login_key, 300);
            }
			return $this->res('', 4024);
		}

		# 是否禁用
		if($find['status'] != 'ENABLE') {
			return $this->res('', 4026);
		}

		# 判断用户密码是否正确 B2B不判断密码的正确性
		if( encrypt_password($data['password']) != $find['password'] && $sysName != 'B2B') {
            if($sysName == BOSS){
                $login_key  = \Library\Key\RedisKeyMap::getLogin($data['username']);
                $redis = R();
                $num = $redis->get($login_key);
                $num = empty($num) ? 1 : (int)$num+1;
                $redis->set($login_key,$num);
                $redis->expire($login_key, 300);
            }
			return $this->res('', 4025); # 密码不正确
		}

		switch($sysName) {
		case POP:

			if($find['group_id'] != MERCHANT_GROUP && $find['group_id'] != SUB_ACCOUNT_GROUP) {

				return $this->res('', 4028); # 用户组不正确
			}
            $api = 'Base.StoreModule.User.SubAccount.findOne';
            $res = $this->invoke($api,['uc_code'=>$find['uc_code']]);
            $res = $res['response'];
            if(!$res && $find['group_id'] == MERCHANT_GROUP)
            {
                $res = D('ScStore')->field('uc_code,tc_code,status,sc_code,name,province,city,area,address,account_bank,account_no,account_name,logo,tpl_status')->where(array('uc_code'=>$find['uc_code']))->find();

                if($res === null) {
                    return $this->res('', 4027); # 商户不存在
                }
                if($res['status'] != 'ENABLE') {
                    return $this->res('', 4029); # 商户被禁用
                }

                //默认创建登录角色
                $api = 'Bll.Pop.User.SubAccount.addDefaultRoles';
                $this->invoke($api,['uc_code'=>$res['uc_code'],'sc_code'=>$res['sc_code']]);

            }

            if(!$res){
                return $this->res('', 5525);
            }
            if($find['status'] != 'ENABLE') {
                return $this->res('', 4029); # 用户被禁用
            }
			$find = array_merge($find, $res);

			break;

		case B2B:
			# 跟微信相关的自己写吧
			if($find['group_id'] != MERMBER_GROUP) {
				return $this->res('', 4028); # 用户组不正确
			}
			$field = 'um.commercial_name,um.username as linkman,um.province,um.city,um.district';
			$res = D('UcMember')->alias('um')->field($field)->where(['uc_code'=>$find['uc_code']])->find();
			if(!$res) {
				return $this->res('', 4019); # 用户基本信息不存在
			}
			$find = array_merge($find, $res);
			break;

        case BOSS:
            $this->startOutsideTrans();
            $login_key  = \Library\Key\RedisKeyMap::getLogin($data['username']);  # 错误次数清0
            $redis = R();
            $redis->set($login_key,0);

            if($find['group_id'] != MERCHANT_GROUP) {
                return $this->res('', 4028); # 用户组不正确
            }
            // 获取sc_code
            $apiPath = "Base.StoreModule.Basic.Store.get";
            $res = $this->invoke($apiPath,$find);
            if($res['status'] != 0){
                return $this->res('',$res['status']);
            }
            $sc_code = $res['response']['sc_code'];

            // 获取用户操作表 无则添加
            $map['sc_code'] = $sc_code;
            $map['uc_code'] = $find['uc_code'];
            $options = D('UcOptions')->where($map)->find();
            if(empty($options)){
                $options = array(
                    'sc_code'=>$sc_code,
                    'uc_code'=>$find['uc_code'],
                    'push_msg'=>'ON',
                    'prompt_sound'=>'ON',
                    'show_img'=>'ON',
                    'create_time'=>NOW_TIME,
                    'update_time'=>NOW_TIME,
                );
                $apiPath = "Base.UserModule.User.User.options";
                $res = $this->invoke($apiPath,$options);
                if($res['status'] != 0){
                    return $this->res('',$res['status']);
                }
            }

            // 查看设备类型 如果不同则添加或更新
            $device_data = array(
                'sc_code'=>$sc_code,
                'uc_code'=>$find['uc_code'],
                'device'=>$data['device'],
                'device_token'=>$data['device_token'],
                );

            $apiPath = "Base.UserModule.User.User.checkDevice";
            $device_res = $this->invoke($apiPath,$device_data);
            if($device_res['status'] != 0){
                return $this->res('',$device_res['status']);
            }


            $msg = array(
                'sc_code'=>$sc_code,
                'uc_code'=>$find['uc_code'],
                'device'=>$data['device'],          # 传入的设备类型
                'role'=>'超级管理员',              
                'push_msg'=>$options['push_msg'],
                'prompt_sound'=>$options['prompt_sound'],
                'show_img'=>$options['show_img'],
                'bind_phone'=>$find['mobile'],
                'counsel_phone'=>C('CALL_NUMBER'),
                );
            $find = $msg;
            break;
		case CMS:
            // do nothing
            // modified by liaoxianwen
            break;
		default:
			return $this->res('', 4023);
		}

		unset($find['password']);
		return $this->res($find);

	}
    /**
     * 处理普通用户 的扩展信息
     * @param type $ori_info
     */
    private function getUcMemberExtendInfo($ori_info){
        $user_info = array();
        $user_info['extend_status'] = $ori_info['status'];
        return $user_info;
    }
    
    /**
     * 处理 商户 的扩展信息
     * @param type $ori_info
     */
    private function getUcMerchantExtendInfo($ori_info){
        $user_info = array();
        $user_info['sc_code'] = $ori_info['sc_code'];
        $user_info['extend_status'] = $ori_info['status'];
        return $user_info;
    }

	/**
	 * 通过openid获取用户基本信息
	 * Base.UserModule.User.User.getUserInfoByOpenid 
	 * @access public
	 * @return void
	 */
	public function getUserInfoByOpenid($data) {
		if( empty($data['openid']) ) {
			return $this->res('openid', PARAMS_ERROR); # 缺少openid
		}
		$find = D('UcUser')->alias('uc')->field('uc.username,uc.uc_code')->join('left join __UC_WEIXIN__ as uw on uc.uc_code=uw.uc_code')->where(['uw.open_id'=>$data['openid']])->find();
		return $this->res($find);
	}

    /**
     * 通过uc_code获取小B用户的邀请码
     * Base.UserModule.User.User.getInviteCode
     * @access public
     * @return void
     */
    public function getInviteCode($data){
        if(empty($data['uc_code'])){
            return $this->res('uc_code',PARAMS_ERROR);
        }
        $result=D('UcMember')->field('invite_code')->where(array('uc_code'=>$data['uc_code']))->select();
        return $this->res($result);
    }
    
    /**
     * 获取双磁对接人
     * Base.UserModule.User.User.getSalesmanList
     * @param type $params
     */
    public function getSalesmanList($params){
        $salesman = D('UcMerchant')->group('salesman')->where(array('salesman'=>array('neq','')))->field('salesman')->select();
        return $this->res($salesman);
    }
    
    public function getMerchantInfo($params){
        $this->_rule = array(
			array('merchant_id', 'require' , PARAMS_ERROR, MUST_CHECK ),  # 
		);
		
		if(!$this->checkInput($this->_rule, $data)){ # 自动校验
			return $this->res($this->getErrorField(),$this->getCheckError());
                }
    }



    /**
     * @api  Boss添加用户操作信息
     * @apiVersion 1.0.1
     * @apiName Base.UserModule.User.User.options
     * @apiTransaction N
     * @apiAuthor Todor <tudou@liangrenwang.com>
     * @apiDate 2015-10-21
     * @apiSampleRequest On
     */

    public function options($params){
        $this->startOutsideTrans();
        $this->_rule = array(
            array('sc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 店铺编码
            array('uc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 客户编码
            array('push_msg', 'require', PARAMS_ERROR, MUST_CHECK),     # 推送消息
            array('prompt_sound', 'require', PARAMS_ERROR, MUST_CHECK), # 提示声音    
            array('show_img', 'require', PARAMS_ERROR, MUST_CHECK),     # 展示商品图片
        );
        if (!$this->checkInput($this->_rule, $params)) { 
            return $this->res($this->getErrorField(), $this->getCheckError());
        }

        $res = D('UcOptions')->add($params);
        if($res <= 0 || $res == FALSE){
            return $this->res(NULL,4040);
        }

        return $this->res(true);

    }


    /**
     * @api  Boss添加用户设备类型
     * @apiVersion 1.0.1
     * @apiName Base.UserModule.User.User.deviceAdd
     * @apiTransaction N
     * @apiAuthor Todor <tudou@liangrenwang.com>
     * @apiDate 2015-10-21
     * @apiSampleRequest On
     */

    public function deviceAdd($params){
        $this->startOutsideTrans();
        $this->_rule = array(
            array('sc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 店铺编码
            array('uc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 客户编码
            array('device_token', 'require', PARAMS_ERROR, ISSET_CHECK), # 设备唯一标识
            array('device', 'require', PARAMS_ERROR, MUST_CHECK),       # 设备类型    
        );
        if (!$this->checkInput($this->_rule, $params)) { 
            return $this->res($this->getErrorField(), $this->getCheckError());
        }

        $data = array(
            'create_time'=>NOW_TIME,
            'update_time'=>NOW_TIME,
            'sc_code'=>$params['sc_code'],
            'uc_code'=>$params['uc_code'],
            'device_token'=>$params['device_token'],
            'device'=>$params['device'],
            );
        $res = D('UcDevice')->add($data);
        if($res <= 0 || $res == FALSE){
            return $this->res(NULL,4041);
        }
        return $this->res(true);
    }


    /**
     * @api  Boss更新用户设备类型
     * @apiVersion 1.0.1
     * @apiName Base.UserModule.User.User.deviceUpdate
     * @apiTransaction N
     * @apiAuthor Todor <tudou@liangrenwang.com>
     * @apiDate 2015-10-21
     * @apiSampleRequest On
     */

    public function deviceUpdate($params){
        $this->startOutsideTrans();
        $this->_rule = array(
            array('sc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 店铺编码
            array('uc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 客户编码
            array('device_token', 'require', PARAMS_ERROR, ISSET_CHECK), # 设备唯一标识
            array('device', 'require', PARAMS_ERROR, MUST_CHECK),       # 设备类型    
        );
        if (!$this->checkInput($this->_rule, $params)) { 
            return $this->res($this->getErrorField(), $this->getCheckError());
        }

        $map['sc_code'] = $params['sc_code'];
        $map['uc_code'] = $params['uc_code'];
        $data = array(
            'device_token'=>$params['device_token'],
            'device'=>$params['device'],
            'update_time'=>NOW_TIME,
            );
        $res = D('UcDevice')->where($map)->save($data);
        if($res <= 0 || $res == FALSE){
            return $this->res(NULL,4042);
        }
        return $this->res(true);

    }


    /**
     * @api  Boss查看用户设备类型
     * @apiVersion 1.0.1
     * @apiName Base.UserModule.User.User.getDevice
     * @apiTransaction N
     * @apiAuthor Todor <tudou@liangrenwang.com>
     * @apiDate 2015-10-26
     * @apiSampleRequest On
     */

    public function getDevice($params){
        $this->_rule = array(
            array('sc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 店铺编码
            array('uc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 客户编码
            array('device_token', 'require', PARAMS_ERROR, ISSET_CHECK), # 设备唯一标识
            array('device', 'require', PARAMS_ERROR, ISSET_CHECK),      # 设备类型  
        );
        if (!$this->checkInput($this->_rule, $params)) { 
            return $this->res($this->getErrorField(), $this->getCheckError());
        }

        $map['sc_code'] = $params['sc_code'];
        $map['uc_code'] = $params['uc_code'];
        !empty($params['device_token']) && $map['device_token'] = $params['device_token'];
        !empty($params['device']) && $map['device'] = $params['device'];
        $res = D('UcDevice')->where($map)->find();

        if($res == FALSE){
            return $this->res(NULL,4055);
        }
        
        return $this->res($res);

    }


    /**
     * @api  Boss查看用户设置
     * @apiVersion 1.0.1
     * @apiName Base.UserModule.User.User.getOptions
     * @apiTransaction N
     * @apiAuthor Todor <tudou@liangrenwang.com>
     * @apiDate 2015-10-21
     * @apiSampleRequest On
     */

    public function getOptions($params){
        $this->_rule = array(
            array('sc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 店铺编码
            array('uc_code', 'require', PARAMS_ERROR, MUST_CHECK),      # 客户编码 
        );
        if (!$this->checkInput($this->_rule, $params)) { 
            return $this->res($this->getErrorField(), $this->getCheckError());
        }

        $where['sc_code'] = $params['sc_code'];
        $where['uc_code'] = $params['uc_code'];
        $options = D('UcOptions')->where($where)->find();
        if($options == FALSE){
            return $this->res(NULL,4043);
        }
        return $this->res($options);
    }


    /**
     * @api  Boss查看用户设置
     * @apiVersion 1.0.1
     * @apiName Base.UserModule.User.User.updateOptions
     * @apiTransaction N
     * @apiAuthor Todor <tudou@liangrenwang.com>
     * @apiDate 2015-10-21
     * @apiSampleRequest On
     */

    public function updateOptions($params){
        $this->startOutsideTrans();
        $this->_rule = array(
            array('sc_code', 'require', PARAMS_ERROR, MUST_CHECK),       # 店铺编码
            array('uc_code', 'require', PARAMS_ERROR, MUST_CHECK),       # 客户编码
            array('push_msg', 'require', PARAMS_ERROR, ISSET_CHECK),     # 推送消息
            array('prompt_sound', 'require', PARAMS_ERROR, ISSET_CHECK), # 提示声音    
            array('show_img', 'require', PARAMS_ERROR, ISSET_CHECK),     # 展示商品图片
        );

        $where['sc_code'] = $params['sc_code'];
        $where['uc_code'] = $params['uc_code'];

        $data = array();
        isset($params['push_msg']) && $data['push_msg'] = $params['push_msg'];
        isset($params['prompt_sound']) && $data['prompt_sound'] = $params['prompt_sound'];
        isset($params['show_img']) && $data['show_img'] = $params['show_img'];
        $data['update_time'] = NOW_TIME;

        $res = D('UcOptions')->where($where)->save($data);

        if($res <= 0 || $res == FALSE){
            return $this->res(NULL,4053);
        }
        return $this->res(true);

    }



    /**
     * @api  APP 首页与登陆页弱网登陆 获取不到设备唯一标识
     * @apiVersion 1.0.1
     * @apiName Base.UserModule.User.User.checkDevice
     * @apiTransaction N
     * @apiAuthor Todor <tudou@liangrenwang.com>
     * @apiDate 2015-10-21
     * @apiSampleRequest On
     */

    public function checkDevice($params){

        $map['sc_code'] = $params['sc_code'];
        $map['uc_code'] = $params['uc_code'];
        !empty($params['device_token']) && $map['device_token'] = $params['device_token'];   # 设备唯一标识
        $map['device'] = $params['device'];               # 设备类型
        $device = D('UcDevice')->where($map)->find();

        if(empty($device)){
            // 检查是否需要更新
            unset($map['device_token']);
            unset($map['device']);

            $device_change = D('UcDevice')->where($map)->find();

            $device = array(
                'sc_code'=>$params['sc_code'],
                'uc_code'=>$params['uc_code'],
                'device_token'=>$params['device_token'],
                'device'=>$params['device'],
                );

            if(empty($device_change)){    # 增加
                $apiPath = "Base.UserModule.User.User.deviceAdd";
            }else{                        # 更新
                $apiPath = "Base.UserModule.User.User.deviceUpdate";
            }

            $res = $this->invoke($apiPath,$device);
            if($res['status'] != 0){
                return $this->res('',$res['status']);
            }
        }
    }




}
?>
