<?php
/**
 * Created by PhpStorm.
 * User: wangguangjian@liangrenwang.com
 * Date: 2015/9/8
 * Time: 15:09
 */

namespace Base\FcModule\Account;

use System\Base;

class OrderAccount extends Base
{
    public function __construct()
    {
        parent::__construct();
    }
    /**
     * 微信对账(判断订单金额与银行传过来的金额是否相等 if yes->修改信息)
     * Base.FcModule.Account.OrderAccount.wechatUpdate
     * 接收数据
     * array $where 查询条件
     * array $field 限制条件
     */
    public function wechatUpdate ($params) {
        $this->_rule = array(
            array('bank_time', 'require', PARAMS_ERROR, MUST_CHECK),           //  到账日期			* 必须字段
            array('start_time', 'require', PARAMS_ERROR, MUST_CHECK),           //  交易开始日期		* 必须字段
            array('end_time', 'require', PARAMS_ERROR, MUST_CHECK),           //  交易结束日期		* 必须字段
            array('bank_code','require', PARAMS_ERROR, MUST_CHECK),             //  银行编码	* 必须字段
            array('id','require', PARAMS_ERROR, MUST_CHECK),   //id编号
        );

        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }

        //取出所需银行信息

        $bankWhere['bank_time'] = $params['bank_time'];
        $bankWhere['type'] = FC_TYPE_WEIXIN;
        $bankInfo = D("FcBankInfo")->field("bank_amount,bank_code")->where($bankWhere)->find();
        if(empty($bankInfo['bank_amount'])) return $this->endInvoke(null,8066);
        //获取所有订单信息
        $orderInfo = $this->getOrderInfo($params);
        //判断金额是否相等并且是否允许对账
        if($orderInfo['all_amount'] != ($bankInfo['bank_amount'] + $orderInfo['poundage'])) return  $this->res(null,8065);
        //修改数据
        try{
            D()->startTrans();
            //拼接数据
            $confirmUpdateWhere['account_status'] = FC_ACCOUNT_STATUS_NO_ACCOUNT;
            $confirmUpdateWhere['b2b_code'] = array('in', $orderInfo['b2bCodes']);
            //待修改的数据
            $confirmUpdateData['balance_status'] = FC_BALANCE_STATUS_YES_BALANCE;
            $confirmUpdateData['account_status'] = FC_ACCOUNT_STATUS_ACCOUNT;
            $confirmUpdateData['bank_code'] = $params['bank_code'];
            $confirmUpdateData['update_time'] = NOW_TIME;
            //修改财务订单状态
            $updateConfirm = D('FcOrderConfirm')->where($confirmUpdateWhere)->save($confirmUpdateData);
            if(!$updateConfirm) return $this->endInvoke(null,8067);

            // 拼接数据
            $bankUpdateWhere['id'] = $params['id'];
            $bankUpdateWhere['bank_time'] = $params['bank_time'];
            $bankUpdateWhere['type'] = FC_TYPE_WEIXIN;
            $bankUpdateWhere['account_status'] = FC_ACCOUNT_STATUS_NO_ACCOUNT;
            //待修改的数据
            $bankUpdateData['account_status'] = FC_ACCOUNT_STATUS_ACCOUNT;
            $bankUpdateData['bank_code'] = $params['bank_code'];
            $bankUpdateData['update_time'] = NOW_TIME;

            $bankUpdateData['order_amount'] = round($orderInfo['all_amount'],2);
            $bankUpdateData['start_time'] = $params['start_time'];
            $bankUpdateData['end_time'] = $params['end_time'];
            $bankUpdateData['order_num'] = $orderInfo['order_num'];
            $bankUpdateData['cost'] = $orderInfo['poundage'];
            //修改银行绑定数据
            $updateConfirm = D('FcBankInfo')->where($bankUpdateWhere)->save($bankUpdateData);
            if(!$updateConfirm) return $this->endInvoke(null,8068);

            D()->commit();
        } catch (\Exception $ex) {
            D()->rollback();
            return $this->res(NULL,8069);
        }
        return $this->res(true);
    }

    /*
     * 获取要对账信息
     * Base.FcModule.Account.OrderAccount.getAccountInfo
     * 接收数据
     * array $where 查询条件
     * array $field 限制条件
     */


    public function getAccountInfo($params) {

        $this->_rule = array(
            array('start_time', 'require', PARAMS_ERROR, MUST_CHECK),           //  交易开始日期		* 必须字段
            array('end_time', 'require', PARAMS_ERROR, MUST_CHECK),           //  交易结束日期		* 必须字段
        );

        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }

        //判断时间是否重复
        if(is_array($this->getBankInfo($params))) return $this->res(null,8070);
        //获取所有订单信息
        $orderInfo = $this->getOrderInfo($params);
        unset($orderInfo['b2bCode']);
        $orderInfo['acc_add'] = bcsub($orderInfo['all_amount'],$orderInfo['poundage'],2);
        return $this->res($orderInfo);
    }

    private function getBankInfo($params){
        $end_time = $params['end_time'] - 86399;
        $where = "(start_time >= {$params['start_time']} and end_time <= {$params['end_time']})
         or (start_time = {$params['start_time']})
         or (end_time = {$params['end_time']})
         or (start_time = {$params['start_time']} and end_time <= {$params['end_time']})
         or (start_time >= {$params['start_time']} and end_time = {$params['end_time']})
         or (start_time = {$end_time})
         ";
        $find = D("FcBankInfo")->where($where)->find();
        return $find;
    }

    /**
     * 微信对账列表
     * Base.FcModule.Account.OrderAccount.wechatLists
     * 接收数据
     * array $where 查询条件
     * array $field 限制条件
     */

    public function wechatLists ($params) {
        $this->_rule = array(
            array('start_time', 'require', PARAMS_ERROR, ISSET_CHECK),           //  开始时间       非必须参数, 默认值 所有
            array('end_time', 'require', PARAMS_ERROR, ISSET_CHECK),            //  结束时间            非必须参数, 默认值 所有
            array('account_status', 'require', PARAMS_ERROR, ISSET_CHECK),             //  对账状态          非必须参数, 默认值 所有
            array('page', 'require', PARAMS_ERROR, ISSET_CHECK)            //分页
    );
        // 自动校验
        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $accountWhere = [];
        ( $params['start_time'] && $params['end_time'] ) ? $accountWhere['bank_time'] = array('BETWEEN', [$params['start_time'], $params['end_time'] ]) : null;
        if(!empty($params['account_status'])){

            if($params['account_status'][FC_ACCOUNT_STATUS_NO_ACCOUNT] && $params['account_status'][FC_ACCOUNT_STATUS_ACCOUNT]){

            }else if($params['account_status'][FC_ACCOUNT_STATUS_ACCOUNT]){
                $accountWhere['account_status'] = FC_ACCOUNT_STATUS_ACCOUNT;
            }else if($params['account_status'][FC_ACCOUNT_STATUS_NO_ACCOUNT]){
                $accountWhere['account_status'] = FC_ACCOUNT_STATUS_NO_ACCOUNT;
            }
        }

        //固定条件
        $accountWhere['type'] = FC_TYPE_WEIXIN;
       // M('Base.OrderModule.B2b.Status')->getRemitBank($data[$key]['pay_method_ext1']);
        $page = isset($params['page']) ? $params['page'] : 1;
        $pageNumber = isset($params['page_number']) ? $params['page_number'] : 20;
        $fileConfirm = 'id,start_time,end_time,order_amount,order_num,bank_amount,bank_time,account_status,bank_code,cost';
        $apiPath = "Com.Common.CommonView.Lists.Lists";
        $orderParams['center_flag'] = SQL_FC;
        $orderParams['sql_flag'] = 'getBankInfoInfo';
        $orderParams['fields'] = $fileConfirm;
        $orderParams['page'] = $page;
        $orderParams['order'] = "LENGTH( start_time ) ASC,bank_time DESC";
        $orderParams['page_number'] = $pageNumber;
        $orderParams['where'] = $accountWhere;
        $orderRes = $this->invoke($apiPath, $orderParams);
        return $this->res($orderRes['response']);
    }

    //获取所有订单金额 订单号
    private function getOrderInfo ($params) {
        $b2bFiled = 'foc.b2b_code,obo.real_amount,foc.cost';
        $advFiled = 'foc.b2b_code,ad.amount,foc.cost';
        $check = FC_THIRD_STATUS_CHECK;
        $weixin =PAY_METHOD_ONLINE_WEIXIN;
        $status = OC_ORDER_PAY_STATUS_PAY;
        $end_time = $params['end_time'] + 86399;
        $sql = "SELECT {$b2bFiled} FROM {$this->tablePrefix}fc_order_confirm AS foc
                JOIN {$this->tablePrefix}oc_b2b_order obo ON obo.b2b_code = foc.b2b_code
                WHERE
                    obo.pay_method ='{$weixin}'
                AND obo.pay_status = '{$status}'
                AND foc.third_status = '{$check}'
                AND obo.pay_time BETWEEN '{$params['start_time']}'
                AND '{$params['end_time']}'
                UNION ALL
                SELECT {$advFiled} FROM {$this->tablePrefix}fc_order_confirm AS foc
                JOIN {$this->tablePrefix}oc_advance ad ON ad.adv_code = foc.b2b_code
                WHERE
                    ad.pay_method = '{$weixin}'
                AND ad. STATUS = '{$status}'
                AND foc.third_status = '{$check}'
                AND ad.pay_time BETWEEN '{$params['start_time']}'
                AND '{$params['end_time']}'
                ";
        $orderInfo = D()->query($sql);

        //取出所有金额 订单号
        $totalAmount = 0;
        $b2bCodes = [];
        $cost = 0;
        foreach($orderInfo as $val){
            $totalAmount += $val['real_amount'];
           $b2bCodes [] = $val['b2b_code'];
            $cost += $val['cost'];

        }




        //拼接数据
        $response = array(
            'all_amount' => $totalAmount,//总金额
            'b2bCodes' => $b2bCodes, //订单号
            'order_num' =>count($b2bCodes), //订单数量
            'poundage' =>$cost, //手续费
        );
        return $response;
    }
    /**
     * Base.FcModule.Account.OrderAccount.advanceAccount
     * 财务对账查询财务所有订单数据数据
     * 接收数据
     * array $where 查询条件
     * array $field 限制条件
     * int   $page  当前页面
     * int   $page_number 查询的条数
     */

    public function advanceAccount($params){
        $this->_rule = array(
            array('sc_name', 'require', PARAMS_ERROR, ISSET_CHECK),          //  店铺名称
            array('adv_code', 'require', PARAMS_ERROR, ISSET_CHECK),          //  预付款订单编号
            array('b2b_code', 'require', PARAMS_ERROR, ISSET_CHECK),          // 商品 订单编码
            array('bank_code', 'require', PARAMS_ERROR, ISSET_CHECK),          //  支付流水号(入金)
            array('pay_method', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付方式
            array('remit_code', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付凭证
            array('pay_status', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付状态
            array('start_time', 'require', PARAMS_ERROR, ISSET_CHECK),       //  开始时间			非必须参数, 默认值 所有
            array('end_time', 'require', PARAMS_ERROR, ISSET_CHECK),         //  结束时间			非必须参数, 默认值 所有
            array('balance_status', 'require', PARAMS_ERROR, ISSET_CHECK),   //  资金状态			非必须参数, 默认值 所有
            array('page', 'require', PARAMS_ERROR, ISSET_CHECK),             //  页码数			非必须参数, 默认值 所有
            array('page_number', 'require', PARAMS_ERROR, ISSET_CHECK),      //  每页显示的数量			非必须参数, 默认值 所有
        );
        // 自动校验
        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        //组装查询条件
        $page = isset($params['page']) ? $params['page'] : 1;
        $pageNumber = isset($params['page_number']) ? $params['page_number'] : 20;
        if(!empty($params['adv_code'])){
            $orderWhere['adv.adv_code']=$params['adv_code'];
        }
        if(!empty($params['balance_status'])){
            $orderWhere['confirm.balance_status']=array('in',$params['balance_status']);
        }
        if(!empty($params['bank_code'])){
            $orderWhere['confirm.bank_code']=$params['bank_code'];
        }
        if(!empty($params['sc_name'])){
            $orderWhere['store.name']=$params['sc_name'];
        }
        if(!empty($params['remit_code'])){
            $orderWhere['adv.remit_code']=$params['remit_code'];
        }
        if(!empty($params['pay_method'])){
            $orderWhere['adv.pay_method']=array('in',$params['pay_method']);
        }
        $orderWhere[] = " adv.status = (CASE WHEN (adv.status = 'PAY' AND adv.pay_method = 'WEIXIN') THEN 'PAY'   ELSE '' END)
        OR adv.status = (CASE WHEN (adv.status = 'PAY' AND adv.pay_method = 'ALIPAY') THEN 'PAY'   ELSE '' END) OR adv.pay_method_ext1='CMBC'";
        # 时间区间确定
        ( $params['start_time'] && $params['end_time'] ) ? $orderWhere['adv.pay_time'] = array('BETWEEN', [$params['start_time'], $params['end_time'] ]) : null;
        //组装sql语句
        //预付款订单(oc_advance)的数据,订单扩展表(extend),财务确定单表(confirm)
        $fileConfirm = 'store.name as sc_name,
                        adv.adv_code,adv.amount,adv.pay_time,adv.pay_method,adv.pay_method_ext1,adv.status,adv.remit_code,adv.create_time,
                        confirm.oc_type,confirm.bank_code,confirm.balance_status,confirm.account_status,confirm.third_status,confirm.cost,
                        voucher.pay_no';
        $apiPath = "Com.Common.CommonView.Lists.Lists";
        $orderParams['center_flag'] = SQL_FC;
        $orderParams['sql_flag'] = 'getAdvanceAccountInfo';
        $orderParams['where'] = $orderWhere;
        $orderParams['fields'] = $fileConfirm;
        $orderParams['page'] = $page;
        $orderParams['order'] = "adv.pay_time desc,adv.create_time desc";
        $orderParams['page_number'] = $pageNumber;
        $orderRes = $this->invoke($apiPath, $orderParams);
        if ( 0 != $orderRes['status']) {
            return $this->res(null, 8051);
        }
        $AccountNoConfirm = $this->accountNoConfirm($orderParams,FC_ORDER_CONFIRM_OC_TYPE_ADVANCE);
        $NoAccount = $this->noAccount($orderParams,FC_ORDER_CONFIRM_OC_TYPE_ADVANCE);
        $orderRes['response']['totalnum_noconfirm'] = $AccountNoConfirm['response']['total_item'];
        $orderRes['response']['total_amount'] = $AccountNoConfirm['response']['total_amount'];
        $orderRes['response']['totalnum_noaccount'] = $NoAccount['response']['total_item'];
        return $this->res($orderRes['response']);
    }

    /**
     * Base.FcModule.Account.OrderAccount.goodsAccount
     * 财务对账查询财务所有订单数据数据
     * 接收数据
     * array $where 查询条件
     * array $field 限制条件
     * int   $page  当前页面
     * int   $page_number 查询的条数
     */

    public function goodsAccount($params){
        $this->_rule = array(
            array('sc_name', 'require', PARAMS_ERROR, ISSET_CHECK),          //  店铺名称
            array('adv_code', 'require', PARAMS_ERROR, ISSET_CHECK),          //  预付款订单编号
            array('b2b_code', 'require', PARAMS_ERROR, ISSET_CHECK),          // 商品 订单编码
            array('bank_code', 'require', PARAMS_ERROR, ISSET_CHECK),          //  支付流水号(入金)
            array('pay_method', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付方式
            array('remit_code', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付凭证
            array('pay_status', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付状态
            array('start_time', 'require', PARAMS_ERROR, ISSET_CHECK),       //  开始时间			非必须参数, 默认值 所有
            array('end_time', 'require', PARAMS_ERROR, ISSET_CHECK),         //  结束时间			非必须参数, 默认值 所有
            array('balance_status', 'require', PARAMS_ERROR, ISSET_CHECK),   //  资金状态			非必须参数, 默认值 所有
            array('page', 'require', PARAMS_ERROR, ISSET_CHECK),             //  页码数			非必须参数, 默认值 所有
            array('page_number', 'require', PARAMS_ERROR, ISSET_CHECK),      //  每页显示的数量			非必须参数, 默认值 所有
        );
        // 自动校验
        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        //组装查询条件
        $page = isset($params['page']) ? $params['page'] : 1;
        $pageNumber = isset($params['page_number']) ? $params['page_number'] : 20;
        if(!empty($params['b2b_code'])){
            $orderWhere['b2b.b2b_code']=$params['b2b_code'];
        }
        if(!empty($params['balance_status'])){
            $orderWhere['confirm.balance_status']=array('in',$params['balance_status']);
        }
        if(!empty($params['bank_code'])){
            $orderWhere['confirm.bank_code']=$params['bank_code'];
        }
        if(!empty($params['sc_name'])){
            $orderWhere['store.name']=$params['sc_name'];
        }
        if(!empty($params['remit_code'])){
            $orderWhere['extend.remit_code']=$params['remit_code'];
        }
        if(!empty($params['pay_method'])){
            $orderWhere['b2b.pay_method']=array('in',$params['pay_method']);
        }
        //默认条件
        $orderWhere[] = " b2b.pay_status = (CASE WHEN (b2b.pay_status = 'PAY' AND b2b.pay_method = 'WEIXIN') THEN 'PAY'   ELSE '' END)
        OR b2b.pay_status = (CASE WHEN (b2b.pay_status = 'PAY' AND b2b.pay_method = 'ALIPAY') THEN 'PAY'   ELSE '' END) OR b2b.ext1='CMBC'";
        # 时间区间确定
        ( $params['start_time'] && $params['end_time'] ) ? $orderWhere['b2b.pay_time'] = array('BETWEEN', [$params['start_time'], $params['end_time'] ]) : null;
        //组装sql语句
        //先查询订单表(b2b_order)的相关数据,订单扩展表(extend),财务确定单表(confirm)
        $fileConfirm = 'store.name as sc_name,
                        b2b.b2b_code,b2b.pay_time,b2b.op_code,b2b.order_status,b2b.pay_status,b2b.pay_method,b2b.ext1,b2b.real_amount as amount,b2b.create_time,
                        extend.remit_code,
                        confirm.oc_type,confirm.bank_code,confirm.balance_status,confirm.account_status,confirm.third_status,confirm.cost,
                        voucher.pay_no';
        $apiPath = "Com.Common.CommonView.Lists.Lists";
        $orderParams['center_flag'] = SQL_FC;
        $orderParams['sql_flag'] = 'getGoodsAccountInfo';
        $orderParams['where'] = $orderWhere;
        $orderParams['fields'] = $fileConfirm;
        $orderParams['page'] = $page;
        $orderParams['order'] = "b2b.pay_time DESC,b2b.create_time DESC";
        $orderParams['page_number'] = $pageNumber;
        $orderRes = $this->invoke($apiPath, $orderParams);
        if ( 0 != $orderRes['status']) {
            return $this->res(null, 8051);
        }
        $AccountNoConfirm = $this->accountNoConfirm($orderParams,FC_ORDER_CONFIRM_OC_TYPE_GOODS);
        $NoAccount = $this->noAccount($orderParams,FC_ORDER_CONFIRM_OC_TYPE_GOODS);
        $orderRes['response']['totalnum_noconfirm'] = $AccountNoConfirm['response']['total_item'];
        $orderRes['response']['total_amount'] = $AccountNoConfirm['response']['total_amount'];
        $orderRes['response']['totalnum_noaccount'] = $NoAccount['response']['total_item'];


        return $this->res($orderRes['response']);
    }

    /**
     * Base.FcModule.Account.OrderAccount.accountNoConfirm.
     * 财务对账查询已到账订单数,和已到账订单总金额
     * 接收数据
     * array $where 查询条件
     * array $field 限制条件
     */
    private function accountNoConfirm($params,$type){
        $orderParams = $params;
        if(count($orderParams['where']['confirm.balance_status']['1'])== 1 && $orderParams['where']['confirm.balance_status']['1'][FC_BALANCE_STATUS_NO_BALANCE]){
            $orderRes['response']['totalnum']=0;
            return $this->res($orderRes['response']);
        }elseif(!$orderParams['where']['confirm.balance_status']['1'][FC_BALANCE_STATUS_YES_BALANCE] && $orderParams['where']['confirm.balance_status']['1'][FC_BALANCE_STATUS_BALANCE]){
            $orderRes['response']['totalnum']=0;
            $orderRes['response']['total_amount']=0;
            return $this->res($orderRes['response']);
        }else{
            $orderParams['where']['confirm.balance_status']=FC_BALANCE_STATUS_YES_BALANCE;
        }
        if($type==FC_ORDER_CONFIRM_OC_TYPE_GOODS){
            $count = D('OcB2bOrder')->alias('b2b')
                ->join("{$this->tablePrefix}fc_order_confirm confirm ON confirm.b2b_code=b2b.b2b_code",'LEFT')
                ->join("{$this->tablePrefix}oc_b2b_order_extend extend ON confirm.oc_code=extend.op_code",'LEFT')
                ->join("{$this->tablePrefix}sc_store store ON confirm.sc_code=store.sc_code",'LEFT')
                ->field("count(b2b.id) as total_item   ,sum(b2b.real_amount) as total_amount")
                ->where($orderParams['where'])
                ->find();
        }elseif($type==FC_ORDER_CONFIRM_OC_TYPE_ADVANCE){
            $count = D('OcAdvance')->alias('adv')
                ->join("{$this->tablePrefix}fc_order_confirm confirm ON confirm.b2b_code=adv.adv_code",'LEFT')
                ->join("{$this->tablePrefix}sc_store store ON confirm.sc_code=store.sc_code",'LEFT')
                ->field("count(adv.id) as total_item   ,sum(adv.amount) as total_amount")
                ->where($orderParams['where'])
                ->find();
        }

        return $this->res($count);
    }

    /**
     * Base.FcModule.account.OrderAccount.noAccount.
     * 财务对账查询未到账订单数量
     * 接收数据
     * array $field 限制条件
     * array $where 查询条件
     */
    private function noAccount($params,$type){
        $orderParams = $params;
        if($orderParams['where']['confirm.balance_status']['1'][FC_BALANCE_STATUS_NO_BALANCE] || !$orderParams['where']['confirm.balance_status'] ){
            $orderParams['where']['confirm.balance_status']=FC_BALANCE_STATUS_NO_BALANCE;
        }elseif(!$orderParams['where']['confirm.balance_status']['1'][FC_BALANCE_STATUS_NO_BALANCE] || $orderParams['where']['confirm.balance_status']){
            $orderRes['response']['totalnum']=0;
            return $this->res($orderRes['response']);
        }

        if($type==FC_ORDER_CONFIRM_OC_TYPE_GOODS){
            $count = D('OcB2bOrder')->alias('b2b')
                ->join("{$this->tablePrefix}fc_order_confirm confirm ON confirm.b2b_code=b2b.b2b_code",'LEFT')
                ->join("{$this->tablePrefix}oc_b2b_order_extend extend ON confirm.oc_code=extend.op_code",'LEFT')
                ->join("{$this->tablePrefix}sc_store store ON confirm.sc_code=store.sc_code",'LEFT')
                ->field("count(b2b.id) as total_item")
                ->where($orderParams['where'])
                ->find();
        }elseif($type==FC_ORDER_CONFIRM_OC_TYPE_ADVANCE){
            $count = D('OcAdvance')->alias('adv')
                ->join("{$this->tablePrefix}fc_order_confirm confirm ON confirm.b2b_code=adv.adv_code",'LEFT')
                ->join("{$this->tablePrefix}sc_store store ON confirm.sc_code=store.sc_code",'LEFT')
                ->field("count(adv.id) as total_item")
                ->where($orderParams['where'])
                ->find();
        }

        return $this->res($count);
    }

    /**
     * Base.FcModule.account.OrderAccount.accountExport.
     * 导出对账全部订单相关明细
     * 接收数据
     */
    public function  accountExport($params) {
        $this->_rule = array(
            array('sc_name', 'require', PARAMS_ERROR, ISSET_CHECK),          //  店铺名称
            array('adv_code', 'require', PARAMS_ERROR, ISSET_CHECK),          //  预付款订单编号
            array('b2b_code', 'require', PARAMS_ERROR, ISSET_CHECK),          // 商品 订单编码
            array('bank_code', 'require', PARAMS_ERROR, ISSET_CHECK),          //  支付流水号(入金)
            array('pay_method', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付方式
            array('remit_code', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付凭证
            array('pay_status', 'require', PARAMS_ERROR, ISSET_CHECK),       //  支付状态
            array('start_time', 'require', PARAMS_ERROR, ISSET_CHECK),       //  开始时间			非必须参数, 默认值 所有
            array('end_time', 'require', PARAMS_ERROR, ISSET_CHECK),         //  结束时间			非必须参数, 默认值 所有
            array('balance_status', 'require', PARAMS_ERROR, ISSET_CHECK),   //  资金状态			非必须参数, 默认值 所有
            array('page', 'require', PARAMS_ERROR, ISSET_CHECK),             //  页码数			非必须参数, 默认值 所有
            array('page_number', 'require', PARAMS_ERROR, ISSET_CHECK),      //  每页显示的数量			非必须参数, 默认值 所有
        );
        $fc_type = $params['fc_type'];
        $data = array();
        $params['pay_method'] = array_filter([
            PAY_METHOD_ONLINE_REMIT => $params[PAY_METHOD_ONLINE_REMIT],
            PAY_METHOD_ONLINE_WEIXIN => $params[PAY_METHOD_ONLINE_WEIXIN],
            PAY_METHOD_ONLINE_ALIPAY => $params[PAY_METHOD_ONLINE_ALIPAY],
        ]);
        $params['balance_status'] = array_filter([
            FC_BALANCE_STATUS_NO_BALANCE => $params[FC_BALANCE_STATUS_NO_BALANCE],
            FC_BALANCE_STATUS_YES_BALANCE => $params[FC_BALANCE_STATUS_YES_BALANCE],
            FC_BALANCE_STATUS_BALANCE => $params[FC_BALANCE_STATUS_BALANCE],
        ]);
        if(!empty($params['balance_status'])){
            $data['where']['confirm.balance_status']=array('in',$params['balance_status']);
        }
        if(!empty($params['bank_code'])){
            $data['where']['confirm.bank_code']=$params['bank_code'];
        }
        if(!empty($params['sc_name'])){
            $data['where']['store.name']=$params['sc_name'];
        }
        $data['title'] = array('订单编号', '付款时间', '付款凭证码','卖家名称','订单状态', '支付方式', '订单金额(元)', '买家实付(元)','手续费(元)','到账金额(元)','到账银行','到账流水号(入金)','资金状态');  //默认导出列标题

        $data['center_flag']  =  SQL_FC;//财务中心
        $apiPath  =  "Com.Common.CommonView.Export.export";
        switch ($fc_type) {
            //商品订单的导出明细
            case 'gALists':
                //组装调用导出api参数
                $data['filename'] = $fc_type;
                $data['fields'] = 'store.name as sc_name,
                        b2b.b2b_code,b2b.pay_time,b2b.op_code,b2b.order_status,b2b.pay_status,b2b.pay_method,b2b.ext1,b2b.real_amount as amount,b2b.create_time,
                        extend.remit_code,
                        confirm.oc_type,confirm.bank_code,confirm.balance_status,confirm.account_status,confirm.third_status,confirm.cost,
                        voucher.pay_no';
                $data['sql_flag']     =  'getGoodsAccountInfo'; //sql标识
                $data['callback_api'] =  'Com.Callback.Export.FcExport.accountGoodsList';
                $data['order']        =  "b2b.pay_time DESC,b2b.create_time DESC";
                $data['template_call_api'] = 'Com.Callback.Export.Template.gALists';
                if(!empty($params['b2b_code'])){
                    $data['where']['b2b.b2b_code']=$params['b2b_code'];
                }
                if(!empty($params['remit_code'])){
                    $data['where']['extend.remit_code']=$params['remit_code'];
                }
                if(!empty($params['pay_method'])){
                    $data['where']['b2b.pay_method']=array('in',$params['pay_method']);
                }
                //默认条件
                $data['where'][] = " b2b.pay_status = (CASE WHEN (b2b.pay_status = 'PAY' AND b2b.pay_method = 'WEIXIN') THEN 'PAY'   ELSE '' END)
                OR b2b.pay_status = (CASE WHEN (b2b.pay_status = 'PAY' AND b2b.pay_method = 'ALIPAY') THEN 'PAY'   ELSE '' END) OR b2b.ext1='CMBC'";
                //限定时间
                ( $params['start_time'] && $params['end_time'] ) ? $data['where']['b2b.pay_time'] = array('BETWEEN', [strtotime($params['start_time'].' 00:00:00'), strtotime($params['end_time'].' 23:59:59')]) : null;
                break;
            //预付款订单对账全部订单导出
            case 'aALists':
                //组装调用导出api参数
                $data['filename'] = $fc_type;
                $data['fields'] = 'store.name as sc_name,
                        adv.adv_code,adv.amount,adv.pay_time,adv.pay_method,adv.pay_method_ext1,adv.status,adv.remit_code,adv.create_time,
                        confirm.oc_type,confirm.bank_code,confirm.balance_status,confirm.account_status,confirm.third_status,confirm.cost,
                        voucher.pay_no';
                $data['sql_flag']     =  'getAdvanceAccountInfo'; //sql标识
                $data['callback_api'] =  'Com.Callback.Export.FcExport.accountAdvanceList';
                $data['order']        =  "adv.pay_time desc,adv.create_time desc";
                $data['template_call_api'] = 'Com.Callback.Export.Template.aALists';
                if(!empty($params['b2b_code'])){
                    $data['where']['adv.adv_code']=$params['b2b_code'];
                }
                if(!empty($params['remit_code'])){
                    $data['where']['adv.remit_code']=$params['remit_code'];
                }
                if(!empty($params['pay_method'])){
                    $data['where']['adv.pay_method']=array('in',$params['pay_method']);
                }
                # 时间区间确定
                ( $params['start_time'] && $params['end_time'] ) ? $data['where']['adv.pay_time'] = array('BETWEEN',  [strtotime($params['start_time'].' 00:00:00'), strtotime($params['end_time'].' 23:59:59')]) : null;
               //固定条件
                $data['where'][] = " adv.status = (CASE WHEN (adv.status = 'PAY' AND adv.pay_method = 'WEIXIN') THEN 'PAY'   ELSE '' END)
                OR adv.status = (CASE WHEN (adv.status = 'PAY' AND adv.pay_method = 'ALIPAY') THEN 'PAY'   ELSE '' END) OR adv.pay_method_ext1='CMBC'";
                break;
        }

        $res = $this->invoke($apiPath, $data);
        return $this->endinvoke($res['response'],$res['status'],'',$res['message']);
    }



    /**
     *
     * Base.FcModule.account.OrderAccount.bankList
     * 未知回款列表
     */
    public function bankList($params)
    {
        $this->_rule = array(
            array('bankTime_start', 'require', PARAMS_ERROR, ISSET_CHECK),
            array('bankTime_end', 'require', PARAMS_ERROR, ISSET_CHECK),
            array('page', 'require', PARAMS_ERROR, ISSET_CHECK),
        );

        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $bankTime_start = $params['bankTime_start'];
        $bankTime_end = $params['bankTime_end'];
        //取出查询条件
        !empty($bankTime_start) && empty($bankTime_end) && $where['bank_time'] = array('egt', $bankTime_start);
        if(!empty($bankTime_start) && !empty($bankTime_end)) {
            $bankTime_end = $bankTime_end + 86399;
            $where['bank_time'] = array('between', array($bankTime_start, $bankTime_end));
        }
        empty($bankTime_start) && !empty($bankTime_end) && $where['bank_time'] = array('elt', $bankTime_end);
        if( $params['status'][0] ) {
            $where['status'] = array('in', $params['status']);  // 处理条件
        }
        $where['type'] = PAY_METHOD_ONLINE_REMIT;
        $where['errorReason'] = array('NEQ','');
        $pageNumber = 20;
        $startNo = ($params['page']-1) * 20;
        $count = D('fc_bank_info')->where($where)->count(); // 查询数据总量
        if($count === false) {
            return $this->res(NULL,8071);
        }
        $res['totalnum'] = $count;
        $res['pageNumber'] = $pageNumber;
        $res['lists'] = D('fc_bank_info')->where($where)->order('id desc')->limit($startNo,$pageNumber)->select();  // 查询信息
        if($res['lists'] === false) {
            return $this->res(NULL,8071);
        } else {
            return $this->res($res);
        }
    }


    /**
     *
     * Base.FcModule.account.OrderAccount.getMyOrders
     * 未知回款对账订单列表
     */
    public function getMyOrders($params)
    {
        $this->_rule = array(
            array('order_start', 'require', PARAMS_ERROR, MUST_CHECK),
            array('order_end', 'require', PARAMS_ERROR, MUST_CHECK),
            array('remit_code_name', 'require', PARAMS_ERROR, ISSET_CHECK),
            array('pay_name', 'require', PARAMS_ERROR, ISSET_CHECK),
            array('page', 'require', PARAMS_ERROR, ISSET_CHECK),
        );
        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $order_start = $params['order_start'];
        $order_end = $params['order_end'];
        if(!empty($params['pay_name'])) {
            $orderWhere[] = "extend.commercial_name='" . $params['pay_name'] ."'";
        }
        if(!empty($params['remit_code_name'])) {
            $orderWhere[] = "extend.remit_code='" . $params['remit_code_name'] ."'";
        }

        //取出查询条件
        $order_end = $order_end + 86399;
        $orderWhere[] = "b2b.create_time  BETWEEN " . $order_start . " AND " . $order_end . " OR adv.create_time BETWEEN "  . $order_start . " AND " . $order_end;
        $orderWhere[] = "b2b.pay_method='" . FC_TYPE_REMIT ."' OR adv.pay_method='" . FC_TYPE_REMIT . "'";
        $orderWhere[] = "b2b.pay_status='" . OC_ORDER_PAY_STATUS_UNPAY ."' OR adv.status='" . OC_ORDER_PAY_STATUS_UNPAY . "'";
        $fileConfirm = 'confirm.oc_type as octype,confirm.b2b_code,b2b.create_time,b2b.real_amount as real_amount,adv.create_time as advtime,adv.amount as advamount,b2b.pay_status as paystatus,adv.status as advstatus,store.name as storename,extend.remit_code as remitcode';
        $orderWhere[] = "confirm.account_status='" . FC_ACCOUNT_STATUS_NO_ACCOUNT ."'";
        $apiPath = "Com.Common.CommonView.Lists.Lists";
        $orderParams['center_flag'] = SQL_FC;
        $orderParams['sql_flag'] = 'getOrderInfo';
        $orderParams['where'] = $orderWhere;
        $orderParams['fields'] = $fileConfirm;
        $orderParams['order'] = "b2b.create_time desc";
        $orderParams['page_number'] = ($params['totalnum'] ? $params['totalnum'] : 1);
        $orderRes = $this->invoke($apiPath, $orderParams);
        return $this->res($orderRes['response'],0);
    }

    /**
     * 未知回款关联
     * Base.FcModule.account.OrderAccount.relateunKnow
     */
    public function relateunKnow($params) {
        $this->_rule = array(
            array('bank_amount', 'require', PARAMS_ERROR, MUST_CHECK),
            array('order_amount', 'require', PARAMS_ERROR, MUST_CHECK),
            array('bank_code', 'require', PARAMS_ERROR, MUST_CHECK),
            array('id', 'require', PARAMS_ERROR, MUST_CHECK),
        );
        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        if(empty($params['b2b_codes'])) {
            return $this->endInvoke(null,8088);
        }
        if($params['bank_amount'] != $params['order_amount']) {  // 订单金额不等于到账金额,则无法关联
            // 提示 不匹配需要原路返回
            return $this->endInvoke(null,8088);
        } else if( ($params['bank_amount'] == $params['order_amount'])) {  // 订单金额等于到账金额 (一条交易流水对多个订单)
            /*if(empty($params['remit_code'])) {  // 无汇款凭证码的话, 无法回填订单汇款码到bank_info中
                return $this->endInvoke(null,8088);
            }*/
            /*// 如果没有汇款凭证码, 但是所选择的订单金额足够, 并且订单总数为1个的话,可以把订单的汇款码写入bank_info
            if(empty($params['remit_code']) && (count($params['b2b_codes']==1)) {
                // 查询到订单的remit_code

            }*/
        }
        try{
            D()->startTrans();
            // 如果匹配, 则把订单和流水关联
            $where['b2b_code'] = array('in', $params['b2b_codes']);
            $data['bank_code'] = $params['bank_code'];
            $data['account_status'] = FC_ACCOUNT_STATUS_ACCOUNT;
            $data['balance_status'] = FC_BALANCE_STATUS_YES_BALANCE;
            $confirmRes = D('FcOrderConfirm')->where($where)->save($data); // 关联order_confirm表( 修改 account_status, 修改用户选中的关联订单 bank_code 为银行汇款明细中的汇款码)
            $uData['status'] = FC_STATUS_END;
            $uData['account_status'] = FC_ACCOUNT_STATUS_ACCOUNT;
            $uData['order_num'] = count($params['b2b_codes']);  // 关联订单数目
            $uData['order_amount'] = $params['order_amount'];
            $bankRes = D('fc_bank_info')->where('id=' . $params['id'])->save($uData);// 关联bank_info表 修改为已处理, 已对账
            D()->commit();
        } catch (\Exception $ex) {
            L($ex->getMessage());
            D()->rollback();
            return $this->res(NULL,6703);
        }
        return $this->res($bankRes,0);
    }

    /**
     * 未知回款"资金原路返回"
     * Base.FcModule.account.OrderAccount.returnunKnow
     */
    public function returnunKnow($params) {
        $this->_rule = array(
            array('id', 'require', PARAMS_ERROR, MUST_CHECK),
        );
        if (!$this->checkInput($this->_rule, $params)) {
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $data = array(
            'status' => FC_STATUS_CLOSE,
        );
        $res = D('fc_bank_info')->where("id =" . $params['id'] . " AND status<>'" . FC_STATUS_CLOSE . "'")->save($data);
        if(!$res) {
            return $this->res(NULL,8087);
        }
        return  $this->res($res,0);
    }

}
