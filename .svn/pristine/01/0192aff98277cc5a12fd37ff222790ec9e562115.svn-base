<?php

/**
 * +---------------------------------------------------------------------
 * | www.yunputong.com 粮人网
 * +---------------------------------------------------------------------
 * | Copyright (c) 2015 http://www.yunputong.com  All rights reserved.
 * +---------------------------------------------------------------------
 * | Author: wangxuemei
 * +---------------------------------------------------------------------
 * | 财务审单、制单、付款
 */

namespace Bll\Cms\Finance;

use System\Base;

class Payment extends Base {
    private $_rule = null; # 验证规则列表
    public function __construct() {
        parent::__construct();
    }

    /**
     * Bll.Cms.Finance.Payment.accountPaidLists
     * @param type $params
     * @return type
     */

    public function accountPaidLists($params) {
        $paymentApiPath = "Base.FcModule.Payment.Payment.accountPaidLists";
        $paymentList = $this->invoke($paymentApiPath, $params);
        $fc_code = [];
        foreach($paymentList['response']['lists'] as $val){
            $fc_code[] = $val['fc_code'];
        }
        if(empty($fc_code))
        {
            return $this->endInvoke(null,8051);
        }
        $confirmWhere = array(
            'fc_code' => $fc_code,
        );

        $confirmApiPath = "Base.FcModule.Payment.Payment.findConfirmLists";
        $confirmList = $this->invoke($confirmApiPath, $confirmWhere);



        $response  = array(
            'paymentLists' => $paymentList['response'],
            'confirmLists' => $confirmList['response']['lists'],
            'confirmStatus' => M('Base.FcModule.Payment.Status.getConfirmStatus')->getConfirmStatus(),
            'payMethodStatus' => M('Base.OrderModule.B2b.Status.getPayMethod')->getPayMethod(),
        );
        return $this->endInvoke($response);
    }

    /**
     * Bll.Cms.Finance.Payment.fcPaymentExport
     * 导出已付款相关订单列表明细excel表
     */
    public function fcPaymentExport($params){
        $apiPath = 'Base.FcModule.Payment.Payment.fcPaymentExport';
        $res = $this->invoke($apiPath, $params);
        return $this->endInvoke($res);
    }

    /**Bll.Cms.Finance.Payment.getAllOrder
     *财务审单&制单&付款 订单列表页
     *
     */
    public function getAllOrder($params){
        $apiPath = "Base.FcModule.Payment.Payment.getAllOrder";
        $list = $this->invoke($apiPath, $params);
        $pay_method_group = M('Base.FcModule.Account.Status.getPayMethod')->getPayMethod();
        $order_type = M('Base.FcModule.Account.Status.getOrderType')->getOrderType();
        $order_status = M('Base.FcModule.Payment.Status.getOrderStatus')->getOrderStatus();
        $list['response']['order_status'] = $order_status;
        $list['response']['order_type'] = $order_type;
        foreach($list['response']['lists']as $k=>$v){
            $data[$k] = $v;
            if($v['ext1']){
                $data[$k]['ext1'] = M('Base.OrderModule.B2b.Status')->getRemitBank($v['ext1']);
            }
            if($v['pay_method_ext1']){
                $data[$k]['pay_method_ext1'] = M('Base.OrderModule.B2b.Status')->getRemitBank($v['pay_method_ext1']);
            }
            if($v['pay_method']){
                $data[$k]['pay_method'] = $pay_method_group[$v['pay_method']];
            }
            if($v['adv_pay_method']){
                $data[$k]['adv_pay_method'] = $pay_method_group[$v['adv_pay_method']];
            }
            if($v['oc_type']){
                $data[$k]['oc_type'] = $order_type[$v['oc_type']];
            }
            $list['response']['lists'] = $data;

        }
        return $this->endInvoke($list['response']);
    }

    /**
     * Bll.Cms.Finance.Payment.getCount
     * 统计所有未审单的订单
     */
    public function getCount($params){
        $apiPath = 'Base.FcModule.Payment.Payment.getCount';
        $res = $this->invoke($apiPath, $params);
        return $this->endInvoke($res['response'],$res['status'],$res['message']);
    }

    /**Bll.Cms.Finance.Payment.checkOrder
     *审单列表
     */
    public function checkOrder($params){
        $apiPath = "Base.FcModule.Payment.Payment.checkOrder";
        $list = $this->invoke($apiPath, $params);
        $pay_method_group = M('Base.FcModule.Account.Status.getPayMethod')->getPayMethod();
        $order_type = M('Base.FcModule.Account.Status.getOrderType')->getOrderType();
        $list['response']['order_type'] = $order_type;
        foreach($list['response']['lists']as $k=>$v){
            $data[$k] = $v;
            if($v['ext1']){
                $data[$k]['ext1'] = M('Base.OrderModule.B2b.Status')->getRemitBank($v['ext1']);
            }
            if($v['pay_method_ext1']){
                $data[$k]['pay_method_ext1'] = M('Base.OrderModule.B2b.Status')->getRemitBank($v['pay_method_ext1']);
            }
            if($v['pay_method']){
                $data[$k]['pay_method'] = $pay_method_group[$v['pay_method']];
            }
            if($v['adv_pay_method']){
                $data[$k]['adv_pay_method'] = $pay_method_group[$v['adv_pay_method']];
            }
            if($v['oc_type']){
                $data[$k]['oc_type'] = $order_type[$v['oc_type']];
            }
            $list['response']['lists'] = $data;
        }
        return $this->endInvoke($list['response']);
    }

    /**
     * Bll.Cms.Finance.Payment.getShopName
     * 获取商铺名称
     */
    public function getShopName($params){

        $apiPath = 'Base.FcModule.Payment.Payment.getShopName';
        $res = $this->invoke($apiPath, $params);
        return $this->endInvoke($res['response'],$res['status'],$res['message']);
    }



    /**Bll.Cms.Finance.Payment.upCheckOrder
     *审单操作
    */
    public function upCheckOrder($params){
        $apiPath = "Base.FcModule.Payment.Payment.upCheckOrder";
        $resInfo = $this->invoke($apiPath, $params);
        return $this->endInvoke($resInfo['status']);
    }

    /**
     * Bll.Cms.Finance.Payment.allOrderExport
     * 导出已付款相关订单列表明细excel表
     */
    public function allOrderExport($params){
        $apiPath = 'Base.FcModule.Payment.Payment.allOrderExport';
        $res = $this->invoke($apiPath, $params);
        return $this->endInvoke($res);
    }

    /**
     * 待制单列表
     * Bll.Cms.Finance.Payment.unCreateOrder
     * @param array $params
     * @return array
     */
    public function unCreateOrder($params) {
        $method = M('Base.OrderModule.B2b.Status.getPayMethod')->getPayMethod();
        $apiPath = "Base.FcModule.Payment.Payment.unCreateOrder";
        $list = $this->invoke($apiPath, $params);
        // 整理数组
        foreach($list['response']['lists'] as $k => &$v) {
            $v['account_no_f'] = rewrite($v['account_no']);
            if($v['oc_type'] == 'GOODS') {   // 如果是商品订单
                $v['p_method'] = $v['bmethod'];
                $v['amount'] = $v['realamount'];
                $v['commercial_name'] = $v['gcname'];
                $v['name'] = $v['gname'];
                foreach($method as $mk=>$mv) {
                    if($v['bmethod'] == $mk) {
                        $v['paymeth'] = $mv;
                        if ($mk == FC_TYPE_REMIT) {
                            $v['newpaytime'] = $v['confirmtime'];
                        } else {
                            $v['newpaytime'] = $v['b2bpaytime'];
                        }
                    }
                }
            } else {
                $v['p_method'] = $v['amethod'];
                $v['amount'] = $v['advamount'];
                $v['commercial_name'] = $v['acname'];
                $v['name'] = $v['aname'];
                foreach($method as $mk=>$mv) {
                    if($v['amethod'] == $mk) {
                        $v['paymeth'] = $mv;
                        if ($mk == FC_TYPE_REMIT) {
                            $v['newpaytime'] = $v['confirmtime'];
                        } else {
                            $v['newpaytime'] = $v['advpaytime'];
                        }
                    }
                }
            }
            $v['bank_money'] = bcsub($v['amount'],$v['cost'],2);
        }
        return $this->endInvoke($list['response'],$list['status'],$list['message']);
    }

    /**
     * 已制单列表
     * Bll.Cms.Finance.Payment.hasCreateOrder
     * @param array $params
     * @return array
     */
    public function hasCreateOrder($params) {
        $apiPath = "Base.FcModule.Payment.Payment.hasCreateOrderPayment";
        $paymentLists = $this->invoke($apiPath, $params);
        $fc_code = array();
        foreach($paymentLists['response']['lists'] as $val){
            $fc_code[] = $val['fc_code'];
        }
        if(empty($fc_code)) {
            return $this->endInvoke(null,0);
        }
        // 收集汇总表中所有的fc_code
        $confirmWhere = array(
            'fc_code' => $fc_code,
            'createStart' => $params['createStart'],
            'createEnd' => $params['createEnd']
        );
        // 查询汇总表关联的所有订单
        $orderapi = "Base.FcModule.Payment.Payment.hasCreateOrderInfo";
        $orderlist = $this->invoke($orderapi, $confirmWhere);
        $response  = array(
            'paymentLists' => $paymentLists['response'],
            'confirmLists' => $orderlist['response']['lists'],
        );
        $method = M('Base.OrderModule.B2b.Status.getPayMethod')->getPayMethod();
        // 整理数组
        foreach($response['paymentLists']['lists'] as &$val){
            $val['account_number_f'] = rewrite($val['account_number']);
            foreach($response['confirmLists'] as &$v){
                if($v['oc_type'] == 'GOODS') {
                    $v['amount'] = $v['real_amount'];
                    $v['commercial_name'] = $v['ocommercial_name'];
                    $v['name'] = $v['real_name'];
                    foreach($method as $mk=>$mv) {
                        if($v['bmethod'] == $mk) {
                            $v['paymeth'] = $mv;
                            if ($mk == FC_TYPE_REMIT) {
                                $v['newpaytime'] = $v['update_time'];
                            } else {
                                $v['newpaytime'] = $v['b2bpaytime'];
                            }
                        }
                    }
                } else {
                    $v['amount'] = $v['advamount'];
                    $v['commercial_name'] = $v['ucommercial_name'];
                    foreach($method as $mk=>$mv) {
                        if($v['amethod'] == $mk) {
                            $v['paymeth'] = $mv;
                            if ($mk == FC_TYPE_REMIT) {
                                $v['newpaytime'] = $v['update_time'];
                            } else {
                                $v['newpaytime'] = $v['oapay_time'];
                            }
                        }
                    }
                }
                if($val['fc_code'] == $v['fc_code']){
                    $v['bank_amount'] = bcsub($v['amount'], $v['cost'],2);
                    $val['orderLists'][] = $v;
                }
            }
        }
        //给数据赋值
        foreach($response['paymentLists']['lists'] as &$val){
            $val['count'] = count($val['orderLists']);
        }
         return $this->endInvoke($response);
    }

    /**
     * 单个制单
     * Bll.Cms.Finance.Payment.createOrder
     * @param array $params
     * @return array
     */
    public function createOrder($params) {
        $apiPath = "Base.FcModule.Payment.Payment.createOrder";
        $confirmapiPath = "Base.FcModule.Payment.Order.updateConfirm";
        if( SC_ACCOUNT_TYPE_ENTERPRISE_ACCOUNT == $params['account_type']) { // 对公账户
            $params['account_type'] = 1;
        } elseif(SC_ACCOUNT_TYPE_PERSONAL_ACCOUNT == $params['account_type']) {  // 对私账户
            $params['account_type'] = 2;
        } else {
            //return $this->res(null,7091);
        }
        $params['status'] = FC_STATUS_ON_PAYMENT;
        try{
            D()->startTrans();
            // 生成fc_code
            $cApiPath = "Com.Tool.Code.CodeGenerate.mkCode";
            $code_params = array(
                'busType' => FC_CODE,
                'preBusType' => FP_CODE,
                'codeType' => SEQUENCE_FC,
            );
            $code_res = $this->invoke($cApiPath, $code_params);
            if ($code_res['status'] !== 0) {
                return $this->endInvoke($code_res['response'], $code_res['status'],$code_res['message']);
            }
            $params['fc_code'] = $code_res['response'] ;
            //插入汇总表 payment  addPayments 返回数据包括商家编码sc_code、生成的fc_code.
            $res = $this->invoke($apiPath, $params);
            if(0 !== $res['status']){
                throw new \Exception($res['message '],$res['status']);
            }
            //更新confirm
            $upConfirm['data'] = array(
                'f_status' => FC_F_STATUS_ON_PAYMENT,
                'fc_code' =>$res['response']['fc_code'],
            );
            $upConfirm['no_update_time'] = 'no';
            $upConfirm['where'] = array(
                'sc_code' => $params['sc_code'],
                'b2b_code'=> array($params['b2b_code']),
                'status' =>  FC_STATUS_CONFIRM,
                'f_status' => FC_F_STATUS_UN_PAYMENT,
            );
            $upConfirmRes = $this->invoke($confirmapiPath, $upConfirm);
            if($upConfirmRes['status'] !== 0) {  // ||  $upConfirmRes['response'] !== $num ){
                throw new \Exception($upConfirmRes['message '],$upConfirmRes['status']);
            }
            // 向银行发送数据
            $bankApiPath = "Base.PayCenter.Info.AccountInfo.Xfer";
            $bankparams = array(
                'gateway' => C('BANK_PARAMS.gateway'),
                'bankName' => $params['account_bank'],
                'insId' => $params['fc_code'],
                'bankBM' => $params['account_code'],
                'amount' => $params['amount'],
                'acntToName' => $params['account_name'],
                'acntToNo' => $params['account_number'],
                'rcvCustType' => $params['account_type']
            );
            if(empty($bankparams['bankName'])) {
                return $this->endInvoke(null,8091);
            }
            if(empty($bankparams['bankBM'])) {
                return $this->endInvoke(null,8092);
            }
            if(empty($bankparams['acntToName'])) {
                return $this->endInvoke(null,8093);
            }
            if(empty($bankparams['acntToNo'])) {
                return $this->endInvoke(null,8094);
            }
            if(empty($bankparams['rcvCustType'])) {
                return $this->endInvoke(null,8095);
            }
            $code_res = $this->invoke($bankApiPath, $bankparams);
            if (0 != $code_res['response']['status']) {
                return $this->endInvoke($code_res['response'], $code_res['response']['status']);
            }
            // 银行返回冗余信息回填
            $data['data'] = json_encode($code_res['response']['response']['list']);
            $where['fc_code'] = $params['fc_code'];
            $updateRes = D('FcOrderPayment')->where($where)->save($data);
            if ($updateRes <= 0 || $updateRes === FALSE) {
                throw new \Exception('事务提交失败',17);
            }
            $commit_res = D()->commit();
            if($commit_res === FALSE){
                throw new \Exception('事务提交失败',17);
            }
        } catch (\Exception $ex) {
            D()->rollback();
            return $this->endInvoke($ex->getMessage(),$ex->getCode());
        }
        return $this->endInvoke('ok',0);
    }

    /**
     * 批量制单
     * Bll.Cms.Finance.Payment.createOrderS
     * @param array $params
     * @return array
     */
    public function createOrderS($params) {
        // 记录所有需要回填状态的b2bcode
        $tmp_params = $params;
        // 拿到所有的b2b_code
        unset($tmp_params['real_name']);
        unset($tmp_params['uc_code']);
        $b2b_codes = array();
        // 拿到所有的商铺编号sc_code
        $sc_codes = array();
        foreach($tmp_params as $k=>$v) {
            $b2b_codes[] = $v[0];
            $sc_codes[] = $v[1];
        }
        //将所有商铺的银行信息查出来
        $storeWhere['sc_code'] = array(
            'in',
            $sc_codes
        );
        $storeFields = 'name as sc_name,sc_code,account_bank,account_name,account_no,account_type,account_code';
        $apiPath = "Com.Common.CommonView.Lists.Lists";
        $storeParams['center_flag'] = SQL_FC;
        $storeParams['sql_flag'] = 'getStoreInfo';
        $storeParams['where'] = $storeWhere;
        $storeParams['fields'] = $storeFields;
        $storeBankInfo = $this->invoke($apiPath, $storeParams);

        if(empty($storeBankInfo['response']['lists'])) {
            return $this->res(null,7091);
        }
        $storeBankInfo = $storeBankInfo['response']['lists'];
        // 对数组进行处理
        foreach($storeBankInfo as $bank_k=>$bank_v) {
            if( SC_ACCOUNT_TYPE_ENTERPRISE_ACCOUNT == $bank_v['account_type']) { // 对公账户
                $storeBankInfo[$bank_k]['account_type'] = 1;
            } elseif(SC_ACCOUNT_TYPE_PERSONAL_ACCOUNT == $bank_v['account_type']) {  // 对私账户
                $storeBankInfo[$bank_k]['account_type'] = 2;
            } else {
                //return $this->res(null,7091);
            }
            foreach ($params as $key => $val) {
                if($bank_v['sc_code'] == $val[1]) {
                    $storeBankInfo[$bank_k]['amount'] = bcadd($storeBankInfo[$bank_k]['amount'], $val[2],2);
                    $storeBankInfo[$bank_k]['make_time'] = NOW_TIME;
                    $storeBankInfo[$bank_k]['status'] = FC_STATUS_ON_PAYMENT;
                    $storeBankInfo[$bank_k]['pay_method'] = $val[3];
                    $storeBankInfo[$bank_k]['create_name'] = $params['real_name'];
                    $storeBankInfo[$bank_k]['uc_code'] = $params['uc_code'];
                }
            }
        }
        $new_data = $storeBankInfo;
        $apiPath = "Base.FcModule.Payment.Payment.createOrderS";
        $confirmapiPath = "Base.FcModule.Payment.Order.updateConfirm";
        try{
            D()->startTrans();
            // 生成fc_code
            foreach($new_data as $k=>$v) {
                $cApiPath = "Com.Tool.Code.CodeGenerate.mkCode";
                $code_params = array(
                    'busType' => FC_CODE,
                    'preBusType' => FP_CODE,
                    'codeType' => SEQUENCE_FC,
                );
                $code_res = $this->invoke($cApiPath, $code_params);
                if ($code_res['status'] !== 0) {
                    return $this->endInvoke($code_res['response'], $code_res['status'],$code_res['message']);
                }
                $new_data[$k]['fc_code'] = $code_res['response'];
                $new_data[$k]['account_number'] = $v['account_no'];
            }
            //插入汇总表 payment  addPayments 返回数据包括商家编码sc_code、生成的fc_code.
            $res = $this->invoke($apiPath, $new_data);
            if(0 !== $res['status']){
                throw new \Exception($res['message '],$res['status']);
            }
            // 批量更新confirm
            foreach($res['response'] as $key=>$val) {
                // 查找当前sc_code所对应的所有b2b_code
                $confirm_b2bcodes = array();
                foreach($tmp_params as $kk=>$vv) {
                    if($vv[1] == $val['sc_code']) {
                        $confirm_b2bcodes[] = $vv[0];
                    }
                }
                $upConfirm['no_update_time'] = 'no';
                $upConfirm['data'] = array(
                    'f_status' => FC_F_STATUS_ON_PAYMENT,
                    'fc_code' => $val['fc_code'],
                );
                $upConfirm['where'] = array(
                    'sc_code' =>  $val['sc_code'],
                    'f_status' => FC_F_STATUS_UN_PAYMENT,
                    'b2b_code' => $confirm_b2bcodes,
                    'status' => FC_STATUS_CONFIRM,
                );
                $upConfirmRes = $this->invoke($confirmapiPath, $upConfirm);
                if($upConfirmRes['status'] !== 0) {  // ||  $upConfirmRes['response'] !== $num ){
                    throw new \Exception($upConfirmRes['message '],$upConfirmRes['status']);
                }
            }
            foreach($new_data as $k=>$v) {
                // 向银行发送数据
                $bankApiPath = "Base.PayCenter.Info.AccountInfo.Xfer";
                $bankparams = array(
                    'gateway' => C('BANK_PARAMS.gateway'),
                    'bankName' => $v['account_bank'],
                    'insId' => $v['fc_code'],
                    'bankBM' => $v['account_code'],
                    'amount' => $v['amount'],
                    'acntToName' => $v['account_name'],
                    'acntToNo' => $v['account_number'],
                    'rcvCustType' => $v['account_type']
                );
                if(empty($bankparams['bankName'])) {
                    return $this->endInvoke(null,8091);
                }
                if(empty($bankparams['bankBM'])) {
                    return $this->endInvoke(null,8092);
                }
                if(empty($bankparams['acntToName'])) {
                    return $this->endInvoke(null,8093);
                }
                if(empty($bankparams['acntToNo'])) {
                    return $this->endInvoke(null,8094);
                }
                if(empty($bankparams['rcvCustType'])) {
                    return $this->endInvoke(null,8095);
                }
                $code_res =  $this->invoke($bankApiPath, $bankparams);
                if (0 != $code_res['status']) {
                    return $this->endInvoke($code_res, $code_res['status']);
                }

                // 银行返回冗余信息回填
                $data['data'] = json_encode($code_res['response']['response']['list']);
                $where['fc_code'] = $v['fc_code'];
                $updateRes = D('FcOrderPayment')->where($where)->save($data);
                if ($updateRes <= 0 || $updateRes === FALSE) {
                    throw new \Exception('事务提交失败',17);
                }
            }
            $commit_res = D()->commit();
            if($commit_res === FALSE){
                throw new \Exception('事务提交失败',17);
            }
        } catch (\Exception $ex) {
            D()->rollback();
            return $this->endInvoke($ex->getMessage(),$ex->getCode());
        }
        return $this->endInvoke('ok',0);
    }
}
