<?php

/**
 * +---------------------------------------------------------------------
 * | www.yunputong.com 粮人网
 * +---------------------------------------------------------------------
 * | Copyright (c) 2015 http://www.yunputong.com  All rights reserved.
 * +---------------------------------------------------------------------
 * | Author: zhoulianlei <zhoulianlei@yunputong.com >
 * +---------------------------------------------------------------------
 * | b2b注册模块
 */

namespace Bll\B2b\User;
use System\Base;

class Region extends Base {

    private $_rule = null; # 验证规则列表
    private static $uc_prefix = null;
    public function __construct() {
        parent::__construct();
        self::$uc_prefix = 'Uc';
    }
    
    /**
     * 注册用户
     * Bll.B2b.User.Region.region
     * @param type $params
     */
    public function region($params){
        $this->_rule = array(
            array('mobile', 'require', PARAMS_ERROR, MUST_CHECK),  //手机号码
       //     array('check_code', 'require', PARAMS_ERROR, MUST_CHECK), //验证码
            array('name', 'require', PARAMS_ERROR, MUST_CHECK), //用户姓名
            array('commercial_name', 'require', PARAMS_ERROR, MUST_CHECK), //商户名
            array('province', 'require', PARAMS_ERROR, ISSET_CHECK), //省
            array('city', 'require', PARAMS_ERROR, ISSET_CHECK), //市
            array('district', 'require', PARAMS_ERROR, ISSET_CHECK), //区
            array('address', 'require', PARAMS_ERROR, ISSET_CHECK), //地址
            array('invite_code', 'require', PARAMS_ERROR, MUST_CHECK), //邀请码
            array('openid', 'require', PARAMS_ERROR, MUST_CHECK), //open_id
        );
        
        if (!$this->checkInput($this->_rule, $params)) { # 自动校验
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $mobile       = $params['mobile'];
        $check_code   = $params['check_code'];
        $commercial_name = $params['commercial_name'];
        $name = $params['name'];
        $province = empty($params['province']) ? C('DEFAULT_PROVINCE') : $params['province'];
        $city = empty($params['city']) ? C('DEFAULT_CITY') : $params['city'];
        $district = $params['district'];
        $address  = $params['address'];
        $invite_code = $params['invite_code'];
        $openid  = $params['openid'];
        //查询该号码是否已经被注册过
        $this->getBasicInfo($mobile);
        //验证码校验  待做
        
        try{
            D()->startTrans();
            //生成基础信息 
            $basic_info = $this->basicInfo($mobile, $mobile, $name);
            $uc_code = $basic_info['uc_code'];
            //生成会员信息
            $member_data = array(
                'uc_code' =>$uc_code,
                'username' => $mobile,
                'commercial_name' => $commercial_name,
                'mobile' => $mobile,
                'name'  => $name,
                'province' => $province,
                'city'   => $city,
                'district' => $district,
                'address' => $address,
                'invite_code'=>$invite_code,
            );
            $this->addMemberInfo($member_data);
            //如果有 邀请码  则生成商家客户信息
            if(!empty($invite_code)){
                $this->addCustomer($uc_code, $invite_code, $name, $mobile);
            }
            //生成微信信息
            if(!empty($openid)){
                $this->addWeixinInfo($openid, $uc_code);
            }
            //添加默认地址
            $this->setDefaultAddress($uc_code, $name, $mobile, $province, $city, $district, $address);
            
            $commit_res = D()->commit();
            if($commit_res === FALSE){
                throw new \Exception('事务提交失败',17);
            }
            return $this->endInvoke(TRUE);
        } catch (\Exception $ex) {
            D()->rollback();
            return $this->endInvoke(NULL,4032);
        }
        
    }
    
    /**
     * 获取注册的初始化信息
     * Bll.B2b.User.Region.getRegisterInit
     * @param type $params
     */
    public function getRegisterInit($params){
        //查询用户是否关注
        $apiPath = "Com.Common.Wx.Mutual.getUserInfo";
        $data = array(
            'openid' => $params['open_id'],
        );
        $weixin_res =$this->invoke($apiPath,$data);
        if($weixin_res['status'] != 0 ){
            return $this->endInvoke($weixin_res);
        }
        //如果未关注
        if($weixin_res['status'] != 0 || empty($weixin_res['response']) || $weixin_res['response']['subscribe'] == 0){
            return $this->endInvoke(NULL,4037);
        }
        
        // 判断用户是否存在
        $apiPath = "Base.WeiXinModule.User.User.getWeixinInfo";
        $res = $this->invoke($apiPath, $params);
        if($res['status'] != 0 ){
            return $this->endInvoke(NULL,$res['status']);
        }
        if(!empty($res['response'])){
            return $this->endInvoke(NULL,4060);
        }

        $this->getAreaList();
    }
    /**
     * 获取市区地址
     * Bll.B2b.User.Region.getAreaList
     * @param type $params
     */
    public function getAreaList(){
        $params = array(
            'pid'=>33,
        );
        $apiPath = "Com.Tool.Region.Region.getAreaBuyPid";
        $area_res = $this->invoke($apiPath,$params);
        return $this->endInvoke($area_res['response'],$area_res['status'],'',$area_res['message']);
    }
    
    /**
     * 发送短信
     * Bll.B2b.User.Region.sendCodeSms
     * @param type $params
     */
    public function sendCodeSms($params){
        $this->_rule = array(
            array('check_code', 1, PARAMS_ERROR, MUST_CHECK,'egt'),
            array('numbers', 'checkArrayInput', PARAMS_ERROR, MUST_CHECK,'function'),
        );
        $numbers=$params['numbers'];
        $this->getBasicInfo($numbers[0]);
        if (!$this->checkInput($this->_rule, $params)) { # 自动校验
            return $this->res($this->getErrorField(), $this->getCheckError());
        }
        $message = "尊敬的用户，您的验证码是：{$params['check_code']}, 我们会为您提供更优质的服务，非常感谢您的加入！";
        if($params['type'] == 'voice'){
            $message = $params['check_code'];
        }
        $data = array(
            'sys_name'=>B2B,
            'numbers' =>$numbers,
            'message' =>$message,
            'type'    =>$params['type'],
        );
        $apiPath = "Com.Common.Message.Sms.send"; 
        $send_res = $this->invoke($apiPath,$data);
        return $this->endInvoke($send_res['response'],$send_res['status'],'',$send_res['message']);
    }
    

    /**
     * 添加会员基本信息
     * @param type $username
     * @param type $mobile
     * @param type $real_name
     * @return type
     */
    private function basicInfo($username,$mobile,$real_name){
        $apiPath = "Base.UserModule.User.Basic.add";
        $data = array(
            'username'  => $username,
            'real_name' => $real_name,
            'mobile'    => $mobile,
            'pre_bus_type' => UC_USER_MERMBER,
        );
        $basic_info = $this->invoke($apiPath, $data);
        if($basic_info['status'] != 0){
            return $this->endInvoke(NULL,$basic_info['status']);
        }
        
        return $basic_info['response'];
    }
    
    
    private function addMemberInfo($data){
        $apiPath = "Base.UserModule.User.User.add";
        $params = array(
            'data'    =>$data,
            'userType'=>UC_USER_MERMBER,
        );
        $extend_info = $this->invoke($apiPath, $params);
        if($extend_info['status'] != 0){
            return $this->endInvoke(NULL,$extend_info['status'],'','邀请码输入错误');
        }
        return true;
    }
    
    /**
     * 根据
     * @param type $invite_code
     */
    private function addCustomer($uc_code,$invite_code,$name,$mobile){
        //根据邀请码获取商家信息
        $apiPath = "Base.UserModule.Customer.Salesman.get";
        $channel_info = $this->invoke($apiPath, array('invite_code'=>$invite_code));
        if(empty($channel_info['response']) || $channel_info['response']['status'] != 'ENABLE'){
            return $this->endInvoke(NULL,5515);
        }
        $sc_code = $channel_info['response']['sc_code'];
        //添加客户信息
        $apiPath = "Base.UserModule.Customer.Customer.add";
        $data = array(
            'sc_code'  => $sc_code,
            'uc_code'  => $uc_code,
            'name'     => $name,
            'mobile'   => $mobile,
            'salesman_id' => $channel_info['response']['id'],
        );
        $customer_res = $this->invoke($apiPath, $data);
        if($customer_res['status'] != 0){
            return $this->endInvoke(NULL,$customer_res['status']);
        }
        return TRUE;
    }
    
    
    private function addWeixinInfo($openid,$uc_code){
        //获取微信信息
        $apiPath = "Com.Common.Wx.Mutual.getUserInfo";
        $data = array(
            'openid'=>$openid,
        );
        $weixin_res = $this->invoke($apiPath,$data);
        if($weixin_res['status'] != 0){
            return $this->endInvoke(NULL,$weixin_res['status'],'',$weixin_res['message']);
        }
        $weixin_info =$weixin_res['response'];
        if(empty($weixin_info)){
            return TRUE;
        }
        
        $apiPath = "Base.WeiXinModule.User.User.getWeixinInfo";
        $params  = array('uc_code'=>$uc_code,'open_id'=>$openid);
        $weixin_info_res = $this->invoke($apiPath, $params);
        if($weixin_info_res['status'] != 0){
            return $this->endInvoke(NULL,$weixin_info_res['status']);
        }
        $data = array(
            'nickname'=>$weixin_info['nickname'],
            'sex'=>$weixin_info['sex'],
            'province'=>$weixin_info['province'],
            'city'=>$weixin_info['city'],
            'country'=>$weixin_info['country'],
            'headimgurl'=>$weixin_info['headimgurl'],
            'remark'=>$weixin_info['remark'],
            'subscribe_time'=>$weixin_info['subscribe_time'],
            'language'=>$weixin_info['language'],
            'groupid'=>$weixin_info['groupid'],
            'unionid'=>$weixin_info['unionid'],
            'subscribe'=>$weixin_info['subscribe'],
            'open_id'  => $openid,
            'uc_code'  => $uc_code,
        );
        if(empty($weixin_info_res['response'])){
            //如果是空的  则添加
            $apiPath = "Base.WeiXinModule.User.User.add";
        }else{
            //更新
            $apiPath = "Base.WeiXinModule.User.User.update";
        }
        
        //是否已经有该信息
        $add_res = $this->invoke($apiPath,$data);
        if($add_res['status'] != 0){
            return $this->endInvoke(NULL,$add_res['status']);
        }
        return TRUE;
    }
    private function getBasicInfo($username){
        $apiPath = "Base.UserModule.User.Basic.getBasicUserInfo";
        $data = array(
            'username' => $username,
        );
        $basic_info = $this->invoke($apiPath, $data);
        if($basic_info['status'] != 0){
            return $this->endInvoke(NULL,$basic_info['status']);
        }
        if(!empty($basic_info['response'])){
            return $this->endInvoke(NULL,4034);
        }
        return TRUE;
    }

   //验证手机号是否注册过
    public function checkMobile($data){
        $mobile=$data['mobile'];
        $res=$this->getBasicInfo($mobile);
        if($res){
            $this->endInvoke();
        }
    }
    /**
     * 添加默认地址
     * @param type $uc_code
     * @param type $real_name
     * @param type $mobile
     * @param type $province
     * @param type $city
     * @param type $district
     * @param type $address
     */
    private function setDefaultAddress($uc_code,$real_name,$mobile,$province,$city,$district,$address){
        $params = array(
            'uc_code'  => $uc_code,
            'real_name'=> $real_name,
            'mobile'   => $mobile,
            'province' => $province,
            'city'     => $city,
            'district' => $district,
            'address'  => $address,
            'is_default'=> 'YES',
        );
        $apiPath = "Base.UserModule.Address.Address.add";
        $add_res = $this->invoke($apiPath,$params);
        if($add_res['status'] != 0){
            return $this->endInvoke(NULL,$add_res['status']);
        }
        return true;
    }



}

?>
